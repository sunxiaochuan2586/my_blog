{# templates/_macros.html (V15 - Cleaned & Corrected) #}

{% macro render_md_editor(field, draft_key) %}
<div class="form-group">
    {{ field.label(class="form-label") }}
    <div class="custom-editor-container">
        <div class="custom-editor-toolbar">
            <!-- æŒ‰é’®å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        {{ field(class="custom-editor-textarea",
        placeholder="åœ¨è¿™é‡Œå¼€å§‹ç”¨ Markdown ä¹¦å†™ä½ çš„æ•…äº‹...",
        value=(field.data if field.data else '')) }}

        <div class="editor-status">
            <span class="editor-status-message"></span>
            <button type="button" class="clear-draft-button" style="display: none;">
                æ¸…é™¤è‰ç¨¿
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        // ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„ ID æ¥é¿å…è„šæœ¬é‡å¤æ‰§è¡Œ
        const scriptId = `editor-script-for-{{ field.id }}`;
        if (document.getElementById(scriptId)) return;

        const container = document.querySelector(`[data-editor-for="{{ field.id }}"]`);
        // å…¼å®¹æ—§çš„å®è°ƒç”¨æ–¹å¼ï¼Œä»¥é˜²ä¸‡ä¸€
        const editorContainer = container || document;

        const toolbar = editorContainer.querySelector('.custom-editor-toolbar');
        const textarea = editorContainer.querySelector('.custom-editor-textarea');

        if (!toolbar || !textarea) return;

        // --- â–¼â–¼â–¼ å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ­£ â–¼â–¼â–¼ ---
        const buttons = [
            { tag: 'B', title: 'åŠ ç²— (Ctrl+B)', prefix: '**', suffix: '**', key: 'b' },
            { tag: 'I', title: 'æ–œä½“ (Ctrl+I)', prefix: '*', suffix: '*', key: 'i' },
            { type: 'separator' },
            { tag: 'H1', title: 'ä¸€çº§æ ‡é¢˜', prefix: '# ', linePrefix: true },
            { tag: 'H2', title: 'äºŒçº§æ ‡é¢˜', prefix: '## ', linePrefix: true },
            { tag: 'H3', title: 'ä¸‰çº§æ ‡é¢˜', prefix: '### ', linePrefix: true },
            { type: 'separator' },
            { tag: 'â€œ', title: 'å¼•ç”¨', prefix: '> ', linePrefix: true },
            { tag: 'UL', title: 'æ— åºåˆ—è¡¨', prefix: '- ', linePrefix: true },
            { tag: 'OL', title: 'æœ‰åºåˆ—è¡¨', prefix: '1. ', linePrefix: true },
            { type: 'separator' },
            { tag: 'ğŸ”—', title: 'é“¾æ¥', prefix: '[', suffix: '](https://)', key: 'k' },
            { tag: 'ğŸ–¼ï¸', title: 'å›¾ç‰‡', prefix: '![', suffix: '](https://)' },
            { tag: '&lt;/&gt;', title: 'è¡Œå†…ä»£ç ', prefix: '`', suffix: '`', type: 'inline-code' },
            { tag: 'ğŸ’»', title: 'ä»£ç å—', prefix: '\n```\n', suffix: '\n```\n' },
        ];

        buttons.forEach(b => {
            if (b.type === 'separator') {
                const separator = document.createElement('div');
                separator.className = 'toolbar-separator';
                toolbar.appendChild(separator);
                return;
            }
            const button = document.createElement('button');
            button.type = 'button';
            button.title = b.title;
            button.innerHTML = b.tag;
            if (b.type === 'inline-code') {
                button.classList.add('btn-inline-code');
            }
            button.addEventListener('click', () => applyMarkdown(b));
            toolbar.appendChild(button);
        });

        function applyMarkdown(format) {
            // ... applyMarkdown å‡½æ•°ä¿æŒä¸å˜ ...
            const start = textarea.selectionStart, end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            if (format.linePrefix) {
                const startLine = textarea.value.lastIndexOf('\n', start - 1) + 1;
                const originalLine = textarea.value.substring(startLine, end);
                const newText = originalLine.split('\n').map((line, index) => format.prefix === '1. ' ? `${index + 1}. ${line}` : `${format.prefix}${line}`).join('\n');
                textarea.value = textarea.value.substring(0, startLine) + newText + textarea.value.substring(end);
                textarea.focus(); textarea.selectionStart = startLine; textarea.selectionEnd = startLine + newText.length;
            } else {
                const replacement = (format.prefix || '') + selectedText + (format.suffix || '');
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.focus();
                if (selectedText) { textarea.selectionStart = start + replacement.length; textarea.selectionEnd = start + replacement.length; }
                else { textarea.selectionStart = start + (format.prefix || '').length; textarea.selectionEnd = start + (format.prefix || '').length; }
            }
            textarea.dispatchEvent(new Event('input'));
        }

        function updateToolbarState() {
            const cursorPosition = textarea.selectionStart;
            buttons.forEach(format => {
                if (!format.prefix) return;
                let button;
                if (format.type === 'inline-code') { button = toolbar.querySelector('.btn-inline-code'); }
                else { button = Array.from(toolbar.querySelectorAll('button')).find(btn => btn.innerHTML === format.tag); }
                if (!button) return;
                let isActive = false;
                const escapedPrefix = format.prefix.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const escapedSuffix = (format.suffix || format.prefix).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const regex = new RegExp(`${escapedPrefix}(.+?)${escapedSuffix}`, 'g');
                let match;
                while ((match = regex.exec(textarea.value)) !== null) {
                    const blockStart = match.index; const blockEnd = match.index + match[0].length;
                    if (cursorPosition > blockStart && cursorPosition < blockEnd) { isActive = true; break; }
                }
                button.classList.toggle('active', isActive);
            });
        }

        textarea.addEventListener('keydown', (e) => { if (e.ctrlKey || e.metaKey) { const key = e.key.toLowerCase(); const format = buttons.find(b => b.key === key); if (format) { e.preventDefault(); applyMarkdown(format); } } });
        textarea.addEventListener('keyup', updateToolbarState);
        textarea.addEventListener('mouseup', updateToolbarState);
        textarea.addEventListener('focus', updateToolbarState);

        // --- è‰ç¨¿é€»è¾‘ ---
        const storageKey = `editor-draft-{{ draft_key }}`;
        const statusMessage = editorContainer.querySelector('.editor-status-message');
        const clearDraftBtn = editorContainer.querySelector('.clear-draft-button');
        let saveInterval;
        function showStatus(text, duration = 2000) { /* ... */ }
        function saveDraft() { /* ... */ }
        function loadDraft() { /* ... */ }
        function clearDraft() { /* ... */ }
        // (ä¸ºç®€æ´çœç•¥äº†è‰ç¨¿å‡½æ•°çš„å…·ä½“å®ç°)
        function showStatus(text, duration = 2000) { statusMessage.textContent = text; statusMessage.classList.add('visible'); setTimeout(() => { statusMessage.classList.remove('visible'); }, duration); }
        function saveDraft() { if (textarea.value.trim().length > 10) { localStorage.setItem(storageKey, textarea.value); const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); showStatus(`è‰ç¨¿å·²äº ${time} ä¿å­˜`); } }
        function loadDraft() { const savedDraft = localStorage.getItem(storageKey); if (savedDraft && !textarea.value.trim()) { textarea.value = savedDraft; showStatus('å·²æ¢å¤æœ¬åœ°è‰ç¨¿'); clearDraftBtn.style.display = 'inline-flex'; } }
        function clearDraft() { localStorage.removeItem(storageKey); clearDraftBtn.style.display = 'none'; showStatus('æœ¬åœ°è‰ç¨¿å·²æ¸…é™¤'); }
        loadDraft();
        textarea.addEventListener('input', () => { clearInterval(saveInterval); saveInterval = setInterval(saveDraft, 3000); clearDraftBtn.style.display = textarea.value.trim().length > 0 ? 'inline-flex' : 'none'; updateToolbarState(); });
        clearDraftBtn.addEventListener('click', () => { if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ä¿å­˜çš„è‰ç¨¿å—ï¼Ÿ')) { textarea.value = ''; clearDraft(); } });
        textarea.closest('form')?.addEventListener('submit', () => { clearInterval(saveInterval); setTimeout(clearDraft, 100); });

        // ç»™ script æ ‡ç­¾æœ¬èº«ä¹ŸåŠ ä¸Šä¸€ä¸ª IDï¼Œé˜²æ­¢å®ƒè¢«é‡å¤åŠ è½½
        const scriptElement = document.createElement('script');
        scriptElement.id = scriptId;
        document.body.appendChild(scriptElement);
    })();
</script>
{% endmacro %}