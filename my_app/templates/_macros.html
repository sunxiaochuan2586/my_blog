{# templates/_macros.html (ç®€åŒ–ç‰ˆ) #}

{% macro render_md_editor(field, draft_key) %}
<div class="form-group">
    {{ field.label(class="form-label") }}
    <div class="custom-editor-container">
        <div class="custom-editor-toolbar">
            <!-- å·¥å…·æ æŒ‰é’®å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        {{ field(class="custom-editor-textarea",
        placeholder="åœ¨è¿™é‡Œå¼€å§‹ç”¨ Markdown ä¹¦å†™ä½ çš„æ•…äº‹...",
        value=(field.data if field.data else '')) }}

        <div class="editor-status">
            <span class="editor-status-message"></span>
            <button type="button" class="clear-draft-button" style="display: none;">
                æ¸…é™¤è‰ç¨¿
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        const scriptId = `editor-script-for-{{ field.id }}`;
        if (document.getElementById(scriptId)) return;

        const toolbar = document.querySelector('.custom-editor-toolbar');
        const textarea = document.querySelector('.custom-editor-textarea');

        if (!toolbar || !textarea) return;

        // å·¥å…·æ æŒ‰é’®é…ç½®
        const buttons = [
            { tag: 'B', title: 'åŠ ç²— (Ctrl+B)', prefix: '**', suffix: '**', key: 'b' },
            { tag: 'I', title: 'æ–œä½“ (Ctrl+I)', prefix: '*', suffix: '*', key: 'i' },
            { type: 'separator' },
            { tag: 'H1', title: 'ä¸€çº§æ ‡é¢˜', prefix: '# ', linePrefix: true },
            { tag: 'H2', title: 'äºŒçº§æ ‡é¢˜', prefix: '## ', linePrefix: true },
            { tag: 'H3', title: 'ä¸‰çº§æ ‡é¢˜', prefix: '### ', linePrefix: true },
            { type: 'separator' },
            { tag: '"', title: 'å¼•ç”¨', prefix: '> ', linePrefix: true },
            { tag: 'UL', title: 'æ— åºåˆ—è¡¨', prefix: '- ', linePrefix: true },
            { tag: 'OL', title: 'æœ‰åºåˆ—è¡¨', prefix: '1. ', linePrefix: true },
            { type: 'separator' },
            { tag: 'ğŸ”—', title: 'é“¾æ¥', prefix: '[', suffix: '](https://)', key: 'k' },
            { tag: 'ğŸ–¼ï¸', title: 'å›¾ç‰‡', prefix: '![', suffix: '](https://)' },
            { tag: '&lt;/&gt;', title: 'è¡Œå†…ä»£ç ', prefix: '`', suffix: '`' },
            { tag: 'ğŸ’»', title: 'ä»£ç å—' }, // <-- ç§»é™¤äº† prefix å’Œ suffix
        ];

        // åˆ›å»ºå·¥å…·æ æŒ‰é’®
        buttons.forEach(b => {
            if (b.type === 'separator') {
                const separator = document.createElement('div');
                separator.className = 'toolbar-separator';
                toolbar.appendChild(separator);
                return;
            }

            const button = document.createElement('button');
            button.type = 'button';
            button.title = b.title;
            button.innerHTML = b.tag;
            button.addEventListener('click', () => applyMarkdown(b));
            toolbar.appendChild(button);
        });

        function applyMarkdown(format) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            // ç‰¹æ®Šå¤„ç†ä»£ç å—æŒ‰é’®
            if (format.tag === 'ğŸ’»') {
                const lang = prompt("è¯·è¾“å…¥ä»£ç è¯­è¨€ (ä¾‹å¦‚: python, javascript, html):", "python");
                if (lang === null) return; // ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥
                
                const prefix = `\n\`\`\`${lang.toLowerCase() || ''}\n`;
                const suffix = '\n```\n';
                const replacement = prefix + selectedText + suffix;

                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.focus();
                textarea.selectionStart = start + prefix.length;
                textarea.selectionEnd = start + prefix.length + selectedText.length;
                
                textarea.dispatchEvent(new Event('input'));
                return; // å¤„ç†å®Œæ¯•ï¼Œæå‰è¿”å›
            }

            if (format.linePrefix) {
                const startLine = textarea.value.lastIndexOf('\n', start - 1) + 1;
                const originalLine = textarea.value.substring(startLine, end);
                const newText = originalLine.split('\n').map((line, index) => {
                    if (format.prefix === '1. ') {
                        return `${index + 1}. ${line}`;
                    }
                    return `${format.prefix}${line}`;
                }).join('\n');

                textarea.value = textarea.value.substring(0, startLine) + newText + textarea.value.substring(end);
                textarea.focus();
                textarea.selectionStart = startLine;
                textarea.selectionEnd = startLine + newText.length;
            } else {
                const replacement = (format.prefix || '') + selectedText + (format.suffix || '');
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                textarea.focus();

                if (selectedText) {
                    textarea.selectionStart = start + replacement.length;
                    textarea.selectionEnd = start + replacement.length;
                } else {
                    textarea.selectionStart = start + (format.prefix || '').length;
                    textarea.selectionEnd = start + (format.prefix || '').length;
                }
            }

            textarea.dispatchEvent(new Event('input'));
        }

        // å¿«æ·é”®æ”¯æŒ
        textarea.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                const key = e.key.toLowerCase();
                const format = buttons.find(b => b.key === key);
                if (format) {
                    e.preventDefault();
                    applyMarkdown(format);
                }
            }
        });

        // è‰ç¨¿åŠŸèƒ½
        const storageKey = `editor-draft-{{ draft_key }}`;
        const statusMessage = document.querySelector('.editor-status-message');
        const clearDraftBtn = document.querySelector('.clear-draft-button');
        let saveInterval;

        function showStatus(text, duration = 2000) {
            statusMessage.textContent = text;
            statusMessage.classList.add('visible');
            setTimeout(() => {
                statusMessage.classList.remove('visible');
            }, duration);
        }

        function saveDraft() {
            if (textarea.value.trim().length > 10) {
                localStorage.setItem(storageKey, textarea.value);
                const time = new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                showStatus(`è‰ç¨¿å·²äº ${time} ä¿å­˜`);
            }
        }

        function loadDraft() {
            const savedDraft = localStorage.getItem(storageKey);
            if (savedDraft && !textarea.value.trim()) {
                textarea.value = savedDraft;
                showStatus('å·²æ¢å¤æœ¬åœ°è‰ç¨¿');
                clearDraftBtn.style.display = 'inline-flex';
            }
        }

        function clearDraft() {
            localStorage.removeItem(storageKey);
            clearDraftBtn.style.display = 'none';
            showStatus('æœ¬åœ°è‰ç¨¿å·²æ¸…é™¤');
        }

        // åˆå§‹åŒ–è‰ç¨¿åŠŸèƒ½
        loadDraft();

        textarea.addEventListener('input', () => {
            clearInterval(saveInterval);
            saveInterval = setInterval(saveDraft, 3000);
            clearDraftBtn.style.display = textarea.value.trim().length > 0 ? 'inline-flex' : 'none';
        });

        clearDraftBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ä¿å­˜çš„è‰ç¨¿å—ï¼Ÿ')) {
                textarea.value = '';
                clearDraft();
            }
        });

        // è¡¨å•æäº¤æ—¶æ¸…é™¤è‰ç¨¿
        textarea.closest('form')?.addEventListener('submit', () => {
            clearInterval(saveInterval);
            setTimeout(clearDraft, 100);
        });

        // æ ‡è®°è„šæœ¬å·²åŠ è½½
        const scriptElement = document.createElement('script');
        scriptElement.id = scriptId;
        document.body.appendChild(scriptElement);
    })();
</script>
{% endmacro %}