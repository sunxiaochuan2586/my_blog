{% extends "base.html" %}

{% block content %}
<div class="post-detail-content">
    <article class="post-content">
        <h1>{{ post.title }}</h1>
        
        <!-- 文章信息和工具栏 -->
        <div class="post-info-bar">
            <div class="post-meta">
                <span class="meta-item">
                    <i class="fas fa-user"></i>
                    {{ post.author.username if post.author else '匿名' }}
                </span>
                <span class="meta-item">
                    <i class="fas fa-calendar"></i>
                    {{ post.date_posted | to_local_time }}
                </span>
                <span class="meta-item">
                    <i class="fas fa-eye"></i>
                    <!-- 在这里显示浏览量 -->
                    {{ post.views or 0 }}
                </span>
                <span class="meta-item">
                    <i class="fas fa-file-alt"></i>
                    <span id="word-count">计算中...</span> 字
                </span>
            </div>
            
            <!-- 小图标工具栏 -->
            <div class="post-tools">
                <button onclick="copyFullContent()" class="tool-icon" id="copy-btn" title="复制全文">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="tool-icon" title="博客HTML" style="opacity: 0.6; cursor: default;">
                    <i class="fas fa-code"></i>
                </button>
                    {% if current_user.is_authenticated and post.author == current_user %}
    <button class="tool-icon" onclick="window.location.href='{{ url_for('routes.update_post', post_id=post.id) }}'" title="编辑文章">
        <i class="fas fa-edit"></i> {# 使用编辑图标 #}
    </button>
    <form action="{{ url_for('routes.delete_post', post_id=post.id) }}" method="POST" style="display:inline;">
        <button type="submit" class="tool-icon" title="删除文章"
            onclick="return confirm('警告：此操作不可逆！\n你确定要永久删除这篇文章吗？');">
            <i class="fas fa-trash-alt"></i> {# 使用删除图标 #}
        </button>
    </form>
    {% endif %}
            </div>
        </div>
        
        <div class="post-body" id="post-content">
            {{ post.content | md | safe }}
        </div>
    </article>
    <!-- 固定的返回顶部按钮 -->
<button id="back-to-top-fixed" class="back-to-top-btn" onclick="backToTop()" title="返回顶部">
    <i class="fas fa-chevron-up"></i>
</button>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    updateWordCount();
    
    // 监听滚动事件，控制返回顶部按钮显示
    const backToTopBtn = document.getElementById('back-to-top-fixed');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
    });
});

function backToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function copyFullContent() {
    const title = document.querySelector('.post-content h1').textContent;
    const content = document.getElementById('post-content').textContent;
    const fullText = `${title}\n\n${content}`;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(fullText).then(() => {
            showCopySuccess();
        }).catch(() => {
            fallbackCopy(fullText);
        });
    } else {
        fallbackCopy(fullText);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        alert('复制失败，请手动复制');
    }
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    const btn = document.getElementById('copy-btn');
    const icon = btn.querySelector('i');
    icon.className = 'fas fa-check';
    btn.style.color = '#16a34a';
    setTimeout(() => {
        icon.className = 'fas fa-copy';
        btn.style.color = '';
    }, 2000);
}

function showStats() {
    const content = document.getElementById('post-content');
    const text = content.textContent;
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    const paragraphs = content.querySelectorAll('p').length;
    const readingTime = Math.ceil(words.length / 200);
    
    document.getElementById('total-words').textContent = words.length;
    document.getElementById('total-paragraphs').textContent = paragraphs;
    document.getElementById('reading-time').textContent = readingTime;
    document.getElementById('stats-display').style.display = 'block';
}

function hideStats() {
    document.getElementById('stats-display').style.display = 'none';
}

function updateWordCount() {
    const content = document.getElementById('post-content');
    const text = content.textContent;
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    document.getElementById('word-count').textContent = words.length;
}
</script>
{% endblock %}
