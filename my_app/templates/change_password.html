{% extends "base.html" %}

{% block content %}
<div class="change-password-container">
    <div class="password-form-card">
        <!-- 头部 -->
        <div class="form-header">
            <div class="header-icon">
                <i class="fas fa-key"></i>
            </div>
            <h1 class="form-title">修改密码</h1>
            <p class="form-subtitle">为了账户安全，请设置一个强密码</p>
        </div>

        <!-- 表单 -->
        <form method="POST" action="" class="password-form" novalidate>
            {{ form.hidden_tag() }}

            <!-- 当前密码 -->
            <div class="form-group">
                {{ form.current_password.label(class="form-label") }}
                <div class="input-wrapper">
                    <i class="fas fa-lock input-icon"></i>
                    {{ form.current_password(class="form-input", placeholder="请输入当前密码") }}
                    <button type="button" class="password-toggle" tabindex="-1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                {% for error in form.current_password.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- 新密码 -->
            <div class="form-group">
                {{ form.new_password.label(class="form-label") }}
                <div class="input-wrapper">
                    <i class="fas fa-key input-icon"></i>
                    {{ form.new_password(class="form-input", placeholder="至少8位，包含大小写、数字和符号", id="new-password") }}
                    <button type="button" class="password-toggle" tabindex="-1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <!-- 密码强度指示器 -->
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strength-fill"></div>
                    </div>
                    <span class="strength-text" id="strength-text">密码强度</span>
                </div>
                {% for error in form.new_password.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- 确认新密码 -->
            <div class="form-group">
                {{ form.new_password2.label(class="form-label") }}
                <div class="input-wrapper">
                    <i class="fas fa-check-circle input-icon"></i>
                    {{ form.new_password2(class="form-input", placeholder="再次输入新密码", id="confirm-password") }}
                    <button type="button" class="password-toggle" tabindex="-1">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div class="match-indicator" id="match-indicator">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
                {% for error in form.new_password2.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- 按钮组 -->
            <div class="form-actions">
                <a href="{{ url_for('routes.profile') }}" class="btn cancel-btn">取消</a>
                {{ form.submit(class="btn btn-primary", id="submit-btn") }}
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const strengthFill = document.getElementById('strength-fill');
    const strengthText = document.getElementById('strength-text');
    const matchIndicator = document.getElementById('match-indicator');
    const submitBtn = document.getElementById('submit-btn');

    // 密码强度检测
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function () {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            strengthFill.className = 'strength-fill';
            if (strength.level) {
                strengthFill.classList.add(strength.level);
            }

            const strengthLabels = { 
                weak: '弱', 
                fair: '一般', 
                good: '良好', 
                strong: '强' 
            };
            strengthText.textContent = `密码强度: ${strengthLabels[strength.level] || '...'}`;

            checkPasswordMatch();
            updateSubmitButtonState();
        });
    }

    // 确认密码检测
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function () {
            checkPasswordMatch();
            updateSubmitButtonState();
        });
    }

    function calculatePasswordStrength(password) {
        let score = 0;
        if (!password) return { score: 0, level: '' };
        
        if (password.length >= 8) score++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        if (/\d/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        
        const levels = ['weak', 'fair', 'good', 'strong'];
        return { score, level: levels[score - 1] || '' };
    }

    function checkPasswordMatch() {
        if (confirmPasswordInput && matchIndicator) {
            if (confirmPasswordInput.value && 
                confirmPasswordInput.value === newPasswordInput.value) {
                matchIndicator.classList.add('show');
            } else {
                matchIndicator.classList.remove('show');
            }
        }
    }

    function updateSubmitButtonState() {
        if (submitBtn) {
            const strength = calculatePasswordStrength(newPasswordInput.value);
            const isStrongEnough = strength.score >= 3;
            const passwordsMatch = newPasswordInput.value && 
                                 newPasswordInput.value === confirmPasswordInput.value;
            
            submitBtn.disabled = !(isStrongEnough && passwordsMatch);
        }
    }
    
    // 初始化按钮状态
    updateSubmitButtonState();
});
</script>
{% endblock %}
