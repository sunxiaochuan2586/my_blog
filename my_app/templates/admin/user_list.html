{% extends "admin/admin_base.html" %}

{% block admin_content %}
<!-- 顶部栏 -->
<div class="admin-top-bar">
    <h1>用户管理</h1>
    <div class="admin-actions">
        <span class="user-count">共 {{ users|length }} 名用户</span>
    </div>
</div>

<!-- 闪现消息 -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">
        <i class="fas fa-info-circle"></i>
        <span>{{ message }}</span>
    </div>
    {% endfor %}
{% endif %}
{% endwith %}

<!-- 筛选工具栏 -->
<div class="filter-section">
    <div class="filter-left">
        <select class="filter-select" id="roleFilter">
            <option value="">所有角色</option>
            <option value="admin">管理员</option>
            <option value="user">普通用户</option>
        </select>
    </div>
    <div class="filter-right">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="搜索用户名或邮箱..." id="searchInput">
        </div>
    </div>
</div>

<!-- 用户列表 -->
<div class="users-container">
    {% if users %}
    <div class="users-grid">
        {% for user in users %}
        <div class="user-card" data-role="{{ 'admin' if user.is_admin else 'user' }}" 
             data-search="{{ (user.username + ' ' + user.email)|lower }}">
            <div class="user-card-header">
                <div class="user-status">
                    {% if user.is_admin %}
                    <span class="status-badge admin">
                        <i class="fas fa-crown"></i>
                        管理员
                    </span>
                    {% else %}
                    <span class="status-badge user">
                        <i class="fas fa-user"></i>
                        普通用户
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="user-card-content">
                <div class="user-avatar">
                    <div class="avatar-circle">
                        {{ user.username[0]|upper }}
                    </div>
                </div>
                <div class="user-info">
                    <h3 class="user-name">{{ user.username }}</h3>
                    <p class="user-email">{{ user.email }}</p>
                    <div class="user-meta">
                        <div class="meta-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>注册于 {{ user.registration_date.strftime('%Y-%m-%d') if user.registration_date else '未知' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="user-card-footer">
                <div class="user-stats">
                    <div class="stat-item">
                        <i class="fas fa-file-alt"></i>
                        <span>{{ user.posts|length }} 篇文章</span>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="action-btn view" onclick="viewUser({{ user.id }})">
                        <i class="fas fa-eye"></i>
                        查看
                    </button>
                    {% if not user.is_admin or current_user.id != user.id %}
                    <button class="action-btn edit" onclick="toggleUserRole({{ user.id }}, {{ user.is_admin|lower }})">
                        <i class="fas fa-user-cog"></i>
                        {% if user.is_admin %}降级{% else %}升级{% endif %}
                    </button>
                    {% endif %}
                    {% if current_user.id != user.id %}
                    <button class="action-btn delete" onclick="deleteUser({{ user.id }})">
                        <i class="fas fa-trash"></i>
                        删除
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3>暂无用户</h3>
        <p>还没有注册用户</p>
    </div>
    {% endif %}
</div>
{% endblock admin_content %}

{% block scripts %}
<script>
// 查看用户详情
function viewUser(userId) {
    // 这里可以打开模态框或跳转到用户详情页
    window.location.href = `/admin/users/${userId}`;
}

// 切换用户角色
function toggleUserRole(userId, isCurrentlyAdmin) {
    const action = isCurrentlyAdmin ? '降为普通用户' : '设为管理员';
    if (confirm(`确定要将此用户${action}吗？`)) {
        // 发送请求到后端
        fetch(`/admin/users/${userId}/toggle-role`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                is_admin: !isCurrentlyAdmin
            })
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('操作失败，请重试');
            }
        })
        .catch(error => {
            alert('操作失败，请重试');
        });
    }
}

// 删除用户
function deleteUser(userId) {
    if (confirm('确定要删除这个用户吗？此操作不可恢复，用户的所有文章也会被删除。')) {
        fetch(`/admin/users/${userId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('删除失败，请重试');
            }
        })
        .catch(error => {
            alert('删除失败，请重试');
        });
    }
}

// 获取CSRF Token
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}

// 搜索功能
document.getElementById('searchInput').addEventListener('input', function(e) {
    filterUsers();
});

// 角色筛选
document.getElementById('roleFilter').addEventListener('change', function(e) {
    filterUsers();
});

// 筛选功能
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedRole = document.getElementById('roleFilter').value;
    const userCards = document.querySelectorAll('.user-card');
    
    userCards.forEach(card => {
        const searchData = card.dataset.search;
        const role = card.dataset.role;
        
        const matchesSearch = !searchTerm || searchData.includes(searchTerm);
        const matchesRole = !selectedRole || role === selectedRole;
        
        if (matchesSearch && matchesRole) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
